<?xml version="1.0" encoding="UTF-8"?>

<included>

  <include resource="org/springframework/boot/logging/logback/defaults.xml"/>

  <springProperty scope="context" name="SPRING_APPLICATION_NAME" source="spring.application.name"/>
  <property name="LOG_FILE"  value="${LOG_PATH:-/var/app_log}/application-${SPRING_APPLICATION_NAME}.log"/>

  <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
    <!-- configure filter to limit console output -->
    <encoder>
      <pattern>${CONSOLE_LOG_PATTERN}</pattern>
      <charset>utf8</charset>
    </encoder>
  </appender>

  <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
    <encoder>
      <pattern>${FILE_LOG_PATTERN}</pattern>
    </encoder>
    <file>${LOG_FILE}</file>
    <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
      <fileNamePattern>${LOG_FILE}.%d{yyyy-MM-dd}.%i.gz</fileNamePattern>
      <maxFileSize>10MB</maxFileSize>
      <maxHistory>90</maxHistory>
    </rollingPolicy>
  </appender>

  <springProfile name="!local">
    <appender name="AMQP" class="org.springframework.amqp.rabbit.logback.AmqpAppender">
      <layout>
        <pattern>
          {
          "time": "%date{ISO8601}",
          "severity": "%level",
          "service": "${SPRING_APPLICATION_NAME:-}",
          "trace": "%X{X-B3-TraceId:-}",
          "span": "%X{X-B3-SpanId:-}",
          "parent": "%X{X-B3-ParentSpanId:-}",
          "exportable": "%X{X-Span-Export:-}",
          "pid": "${PID:-}",
          "thread": "%thread",
          "class": "%logger{40}",
          "rest": "%message"
          }
        </pattern>
      </layout>

      <!-- RabbitMQ connection -->
      <host>rabbitmq-server</host>
      <port>5672</port>
      <username>rabbitmq</username>
      <password>password</password>

      <applicationId>${spring.application.name}</applicationId>
      <routingKeyPattern>api-log-key</routingKeyPattern>
      <declareExchange>true</declareExchange>
      <exchangeType>direct</exchangeType>
      <exchangeName>ex_logstash</exchangeName>

      <generateId>true</generateId>
      <charset>UTF-8</charset>
      <durable>true</durable>
      <deliveryMode>PERSISTENT</deliveryMode>
    </appender>
  </springProfile>
</included>